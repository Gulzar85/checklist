{% extends 'base.html' %}

{% block title %}{% if audit.is_completed %}View Audit -{% else %}Audit Form -{% endif %} {{ audit.restaurant.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Progress Sidebar -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm progress-section sticky-top" style="top: 20px;">
                <div class="card-header {% if audit.is_completed %}bg-secondary{% else %}mcd-bg-red{% endif %} text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line"></i>
                        {% if audit.is_completed %}Audit Results{% else %}Audit Progress{% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Restaurant:</strong> {{ audit.restaurant.name }}<br>
                        <strong>Date:</strong> {{ audit.audit_date|date:"M d, Y" }}<br>
                        <strong>Auditor:</strong> {{ audit.auditor_name.get_full_name|default:audit.auditor_name.username }}
                        {% if audit.is_completed %}
                        <br><strong>Completed:</strong> {{ audit.updated_at|date:"M d, Y H:i" }}
                        {% endif %}
                    </div>

                    <!-- Quick Navigation -->
                    <div class="mb-3">
                        <label class="form-label fw-bold text-danger">Jump to Section:</label>
                        <select class="form-select" id="sectionJump" onchange="jumpToSection(this.value)">
                            <option value="">Select Section...</option>
                            {% for data in section_data %}
                            <option value="section-{{ data.section.id }}">
                                {{ data.section.name }}
                                <span id="section-badge-{{ data.section.id }}">(0/{{ data.questions|length }})</span>
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="progress-container">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Submission Status Badge -->
                    {% if audit.is_completed %}
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle"></i><br>
                        <strong>COMPLETED</strong><br>
                        <small>This audit is finalized and read-only</small>
                    </div>
                    {% endif %}

                    <!-- Auto-save Status -->
                    <div id="save-status" class="mt-2" style="display: none;">
                        <div class="alert alert-success alert-dismissible fade show py-2" role="alert">
                            <small><i class="fas fa-check-circle"></i> <span id="save-message">Changes saved</span></small>
                            <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="btn-group w-100 mb-2" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="navigateSection('prev')">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="navigateSection('next')">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Submit Button (Only show if not completed) -->
                    {% if not audit.is_completed %}
                    <div class="mt-2">
                        <button class="btn btn-success w-100" onclick="submitAudit()">
                            <i class="fas fa-paper-plane"></i> Finalize Audit
                        </button>
                    </div>
                    {% endif %}

                    <!-- Navigation Links -->
                    <div class="mt-2">
                        <a href="{% url 'core:dashboard' %}" class="btn btn-outline-primary btn-sm w-100 mb-1">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                        <a href="{% url 'core:audit_list' %}" class="btn btn-outline-secondary btn-sm w-100">
                            <i class="fas fa-list"></i> All Audits
                        </a>
                        {% if audit.is_completed %}
                        <a href="{% url 'core:audit_results' audit.id %}" class="btn mcd-btn-primary btn-sm w-100 mt-1">
                            <i class="fas fa-chart-bar"></i> View Results
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <div class="col-md-9">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-check"></i>
                        {% if audit.is_completed %}View Audit -{% else %}Audit Form -{% endif %} {{ audit.restaurant.name }}
                        <small class="text-muted ms-2" id="current-section-info"></small>
                    </h4>
                    <div id="global-save-status" class="text-muted small">
                        {% if audit.is_completed %}
                        <i class="fas fa-lock"></i> Read Only
                        {% else %}
                        <i class="fas fa-save"></i> Auto-save enabled
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Single Form - All Sections -->
                    <form id="audit-form">
                        {% for data in section_data %}
                        <div class="section-container" id="section-{{ data.section.id }}">
                            <div class="card border-0 shadow-sm mb-4 section-card">
                                <div class="card-header d-flex justify-content-between align-items-center {% if audit.is_completed %}bg-light{% else %}mcd-bg-red text-white{% endif %}">
                                    <div>
                                        <h5 class="mb-0">
                                            <i class="fas fa-folder"></i>
                                            Section {{ forloop.counter }}: {{ data.section.name }}
                                        </h5>
                                        {% if data.section.description %}
                                        <p class="mb-0 {% if audit.is_completed %}text-muted{% else %}text-light{% endif %} small">
                                            {{ data.section.description }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-light text-dark">
                                            {{ forloop.counter }}/{{ section_data|length }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    {% for question in data.questions %}
                                    <div class="card border question-card mb-3 {% if question.is_critical %}border-danger critical-question{% endif %} {% if audit.is_completed %}border-light{% endif %}"
                                         id="question-{{ data.section.id }}-{{ question.id }}">
                                        <div class="card-body {% if audit.is_completed %}bg-light{% endif %}">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6 class="card-title">
                                                        Q{{ forloop.counter }}: {{ question.text }}
                                                        {% if question.is_critical %}
                                                        <span class="badge bg-danger ms-2">Critical</span>
                                                        {% endif %}
                                                    </h6>
                                                    <p class="text-muted small mb-2">
                                                        Possible Points: <strong>{{ question.possible_points }}</strong>
                                                    </p>
                                                </div>
                                                <div class="col-md-4">
                                                    <!-- Score Input -->
                                                    <div class="mb-2">
                                                        <label class="form-label fw-bold text-danger">Score:</label>
                                                        {% if audit.is_completed %}
                                                        <div class="form-control bg-light">
                                                            <strong>{{ question.scored_points }}</strong>
                                                            <small class="text-muted float-end">/ {{ question.possible_points }}</small>
                                                        </div>
                                                        {% else %}
                                                        <input type="number"
                                                               class="form-control score-input"
                                                               data-section="{{ data.section.id }}"
                                                               data-question="{{ question.id }}"
                                                               min="0"
                                                               max="{{ question.possible_points }}"
                                                               step="0.01"
                                                               value="{{ question.scored_points }}"
                                                               oninput="scheduleSave(this)">
                                                        {% endif %}
                                                    </div>

                                                    <!-- Comments -->
                                                    <div class="mb-2">
                                                        <label class="form-label fw-bold text-danger">Comments:</label>
                                                        {% if audit.is_completed %}
                                                        <div class="form-control bg-light" style="min-height: 80px;">
                                                            {% if question.comments %}
                                                            {{ question.comments }}
                                                            {% else %}
                                                            <span class="text-muted">No comments</span>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <textarea class="form-control comments-input"
                                                                  data-section="{{ data.section.id }}"
                                                                  data-question="{{ question.id }}"
                                                                  rows="3"
                                                                  placeholder="Add comments or observations..."
                                                                  oninput="scheduleSave(this)">{{ question.comments }}</textarea>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Question Save Status -->
                                                    {% if not audit.is_completed %}
                                                    <div id="question-{{ data.section.id }}-{{ question.id }}-status"
                                                         class="save-status-indicator mt-1" style="display: none;">
                                                        <small class="text-success"><i class="fas fa-check"></i> Saved</small>
                                                    </div>
                                                    {% endif %}

                                                    <!-- Corrective Action Indicator -->
                                                    {% if question.needs_corrective_action %}
                                                    <div class="mt-2">
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                            Corrective Action Needed
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        No questions available for this section.
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </form>

                    <!-- Navigation Buttons at Bottom -->
                    {% if not audit.is_completed %}
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline-primary" onclick="navigateSection('prev')">
                            <i class="fas fa-chevron-left"></i> Previous Section
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="navigateSection('next')">
                            Next Section <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Success
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="successMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Error
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let saveTimeouts = {};
    let isSaving = false;
    const SAVE_DELAY = 1500;
    let currentSectionIndex = 0;
    const sections = [
        {% for data in section_data %}
        "section-{{ data.section.id }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const isCompleted = {% if audit.is_completed %}true{% else %}false{% endif %};
    const auditId = {{ audit.id }};

    // CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Initialize on page load
    $(document).ready(function() {
        showSection(currentSectionIndex);
        loadProgress();
        updateSectionBadges();

        if (!isCompleted) {
            setInterval(loadProgress, 30000);
        }

        // Keyboard navigation
        $(document).keydown(function(e) {
            if (isCompleted) return;

            if (e.key === 'ArrowLeft' && (e.ctrlKey || e.altKey)) {
                e.preventDefault();
                navigateSection('prev');
            } else if (e.key === 'ArrowRight' && (e.ctrlKey || e.altKey)) {
                e.preventDefault();
                navigateSection('next');
            }
        });
    });

    // Navigation functions
    function showSection(index) {
        // Hide all sections
        $('.section-container').hide();

        // Show current section
        $(`#${sections[index]}`).show();

        // Update current section info
        const sectionName = $(`#${sections[index]} .card-header h5`).text();
        $('#current-section-info').text(`- ${sectionName.split(': ')[1]}`);

        // Update URL hash
        window.location.hash = sections[index];

        // Scroll to top of section
        $('html, body').animate({
            scrollTop: $(`#${sections[index]}`).offset().top - 100
        }, 500);
    }

    function navigateSection(direction) {
        if (direction === 'next' && currentSectionIndex < sections.length - 1) {
            currentSectionIndex++;
        } else if (direction === 'prev' && currentSectionIndex > 0) {
            currentSectionIndex--;
        }

        showSection(currentSectionIndex);
        updateNavigationButtons();
    }

    function jumpToSection(sectionId) {
        if (!sectionId) return;

        const index = sections.indexOf(sectionId);
        if (index !== -1) {
            currentSectionIndex = index;
            showSection(currentSectionIndex);
            updateNavigationButtons();
        }
    }

    function updateNavigationButtons() {
        // Update dropdown selection
        $('#sectionJump').val(sections[currentSectionIndex]);

        // You can also update button states here if needed
    }

    // Auto-save functionality (same as before with minor adjustments)
    function scheduleSave(element) {
        if (isCompleted) return;

        const $input = $(element);
        const sectionId = $input.data('section');
        const questionId = $input.data('question');
        const key = `${sectionId}_${questionId}`;

        if (saveTimeouts[key]) {
            clearTimeout(saveTimeouts[key]);
        }

        showSavingIndicator(sectionId, questionId);

        saveTimeouts[key] = setTimeout(() => {
            saveResponse(sectionId, questionId);
        }, SAVE_DELAY);
    }

    function showSavingIndicator(sectionId, questionId) {
        if (isCompleted) return;
        const $indicator = $(`#question-${sectionId}-${questionId}-status`);
        $indicator.html('<small class="text-warning"><i class="fas fa-spinner fa-spin"></i> Saving...</small>');
        $indicator.fadeIn(200);
    }

    function showSavedIndicator(sectionId, questionId) {
        if (isCompleted) return;
        const $indicator = $(`#question-${sectionId}-${questionId}-status`);
        $indicator.html('<small class="text-success"><i class="fas fa-check"></i> Saved</small>');

        setTimeout(() => {
            $indicator.fadeOut(1000);
        }, 2000);
    }

    function saveResponse(sectionId, questionId) {
        if (isCompleted) {
            showError('This audit has been completed and cannot be modified.');
            return;
        }

        if (isSaving) {
            setTimeout(() => saveResponse(sectionId, questionId), 500);
            return;
        }

        isSaving = true;

        const scoredPoints = $(`.score-input[data-section="${sectionId}"][data-question="${questionId}"]`).val();
        const comments = $(`.comments-input[data-section="${sectionId}"][data-question="${questionId}"]`).val();

        $.ajax({
            url: "{% url 'core:save_response' %}",
            type: "POST",
            headers: {'X-CSRFToken': csrftoken},
            data: {
                'audit_id': auditId,
                'section_id': sectionId,
                'question_id': questionId,
                'scored_points': scoredPoints || 0,
                'comments': comments || ''
            },
            success: function(response) {
                isSaving = false;

                if (response.success) {
                    showSavedIndicator(sectionId, questionId);
                    loadProgress();
                    updateSectionBadges();

                    const $questionCard = $(`#question-${sectionId}-${questionId}`);
                    if (parseFloat(scoredPoints) === 0 && $questionCard.hasClass('critical-question')) {
                        $questionCard.addClass('border-warning');
                    } else {
                        $questionCard.removeClass('border-warning');
                    }
                } else {
                    showError('Failed to save: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                isSaving = false;
                console.error('Error saving response:', error);
                showError('Error saving response. Please check your connection.');

                const $indicator = $(`#question-${sectionId}-${questionId}-status`);
                $indicator.html('<small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Save failed</small>');
                $indicator.fadeIn(200);
            }
        });
    }

    function updateSectionBadges() {
        if (isCompleted) return;

        {% for data in section_data %}
        const section{{ data.section.id }}Answered = $(`.score-input[data-section="{{ data.section.id }}"]`).filter(function() {
            return $(this).val() !== '' && $(this).val() !== '0';
        }).length;
        $(`#section-badge-{{ data.section.id }}`).text(`(${section{{ data.section.id }}Answered}/{{ data.questions|length }})`);
        {% endfor %}
    }

    // Progress and submission functions (same as before)
    function loadProgress() {
        $.ajax({
            url: "{% url 'core:audit_progress' audit.id %}",
            type: "GET",
            success: function(response) {
                let progressHtml = '';

                if (response.progress && response.progress.length > 0) {
                    response.progress.forEach(function(section) {
                        const progressPercent = Math.round(section.percentage);
                        const sectionScore = section.section_score || 0;
                        const sectionPercentage = section.section_percentage || 0;

                        progressHtml += `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <small><strong>${section.section_name}</strong></small>
                                    <small>${section.answered || 0}/${section.total || 0}</small>
                                </div>
                                <div class="progress mb-1" style="height: 8px;">
                                    <div class="progress-bar {% if progressPercent == 100 %}bg-success{% else %}bg-primary{% endif %}" role="progressbar"
                                         style="width: ${progressPercent}%"
                                         aria-valuenow="${progressPercent}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Score: ${sectionScore.toFixed(2)}</small>
                                    <small class="text-muted">${sectionPercentage.toFixed(1)}%</small>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    progressHtml = '<div class="alert alert-info">No progress data available</div>';
                }

                $('#progress-container').html(progressHtml);
            },
            error: function(xhr, status, error) {
                console.error('Error loading progress:', error);
                $('#progress-container').html('<div class="alert alert-danger">Error loading progress data</div>');
            }
        });
    }

    function submitAudit() {
        if (isCompleted) {
            showError('This audit has already been completed.');
            return;
        }

        if (confirm('Are you sure you want to finalize this audit? This action cannot be undone.')) {
            const $submitBtn = $('button[onclick="submitAudit()"]');
            const originalText = $submitBtn.html();
            $submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Finalizing...');
            $submitBtn.prop('disabled', true);

            const pendingSaves = Object.keys(saveTimeouts);
            if (pendingSaves.length > 0) {
                pendingSaves.forEach(key => {
                    const [sectionId, questionId] = key.split('_');
                    clearTimeout(saveTimeouts[key]);
                    saveResponse(sectionId, questionId);
                });
            }

            setTimeout(() => {
                $.ajax({
                    url: "{% url 'core:submit_audit' audit.id %}",
                    type: "POST",
                    headers: {'X-CSRFToken': csrftoken},
                    success: function(response) {
                        if (response.success) {
                            showSuccess(`
                                <div class="text-center">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5>Audit Finalized Successfully!</h5>
                                    <div class="mt-3">
                                        <strong>Total Score:</strong> ${response.total_score.toFixed(2)}<br>
                                        <strong>Percentage:</strong> ${response.total_percentage.toFixed(1)}%<br>
                                        <strong>Grade:</strong> <span class="badge bg-success">${response.grade}</span>
                                    </div>
                                    <p class="mt-3 text-muted">Redirecting to results page...</p>
                                </div>
                            `);

                            disableForm();
                            setTimeout(function() {
                                window.location.href = "{% url 'core:audit_results' audit.id %}";
                            }, 3000);
                        } else {
                            showError(response.message);
                            $submitBtn.html(originalText);
                            $submitBtn.prop('disabled', false);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error submitting audit:', error);
                        showError('Error finalizing audit. Please try again.');
                        $submitBtn.html(originalText);
                        $submitBtn.prop('disabled', false);
                    }
                });
            }, 1000);
        }
    }

    function disableForm() {
        $('.score-input, .comments-input').prop('readonly', true).addClass('bg-light');
        $('button[onclick="submitAudit()"]').prop('disabled', true).html('<i class="fas fa-check"></i> Completed');
    }

    function showSuccess(message) {
        $('#successMessage').html(message);
        $('#successModal').modal('show');
    }

    function showError(message) {
        $('#errorMessage').text(message);
        $('#errorModal').modal('show');
    }
</script>

<style>
    .section-container {
        display: none;
    }

    .section-container:first-child {
        display: block;
    }

    .sticky-top {
        position: sticky;
        z-index: 100;
    }

    .save-status-indicator {
        transition: all 0.3s ease;
    }

    .question-card {
        transition: all 0.3s ease;
    }

    .question-card.border-warning {
        border-left: 4px solid #ffc107 !important;
    }

    .critical-question {
        border-left: 4px solid #dc3545 !important;
        background-color: #fff5f5;
    }

    .form-control[readonly] {
        background-color: #f8f9fa !important;
        border-color: #dee2e6;
    }

    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}